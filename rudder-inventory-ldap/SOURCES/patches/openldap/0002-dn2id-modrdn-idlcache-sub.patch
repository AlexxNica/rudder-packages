commit 1760f0e33279e947fe2de5075a81cfb479654ffb
Author: Jonathan Clarke <jonathan.clarke@normation.com>
Date:   Tue Feb 23 02:08:50 2016 +0100

    Quick fix to avoid incomplete search results after a MODRDN subtree rename with back-hdb and idlcachesize

diff --git a/servers/slapd/back-bdb/dn2id.c b/servers/slapd/back-bdb/dn2id.c
index a029602..c8ef278 100644
--- a/servers/slapd/back-bdb/dn2id.c
+++ b/servers/slapd/back-bdb/dn2id.c
@@ -571,6 +571,7 @@ hdb_dn2id_add(
 
 	/* Update all parents' IDL cache entries */
 	if ( rc == 0 && bdb->bi_idl_cache_size ) {
+		int tmprc;
 		ID tmp[2];
 		char *ptr = ((char *)&tmp[1])-1;
 		key.data = ptr;
@@ -582,7 +583,14 @@ hdb_dn2id_add(
 			*ptr = DN_SUBTREE_PREFIX;
 			for (; eip && eip->bei_parent->bei_id; eip = eip->bei_parent) {
 				tmp[1] = eip->bei_id;
-				bdb_idl_cache_add_id( bdb, db, &key, e->e_id );
+				/* If the entry we're adding has kids (modrdn), just delete any subtree
+				 * caches that would include this result so they are rebuilt */
+				tmprc = hdb_dn2id_children( op, txn, e );
+				if (tmprc == DB_NOTFOUND) {
+					bdb_idl_cache_add_id( bdb, db, &key, e->e_id );
+				} else {
+					bdb_idl_cache_del( bdb, db, &key );
+				}
 			}
 			/* Handle DB with empty suffix */
 			if ( !op->o_bd->be_suffix[0].bv_len && eip ) {
