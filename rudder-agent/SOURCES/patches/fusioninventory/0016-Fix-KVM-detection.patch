From 4cd9049b3e7b4efc34d0ae68cfecf9c4fd20fe1b Mon Sep 17 00:00:00 2001
From: Nicolas Charles <nicolas.charles@normation.com>
Date: Wed, 14 Sep 2016 17:11:28 +0200
Subject: [PATCH] Fix KVM detection

---
 .../Agent/Task/Inventory/Generic/Dmidecode/Bios.pm | 22 ++++++++++++++--------
 1 file changed, 14 insertions(+), 8 deletions(-)

diff --git a/lib/FusionInventory/Agent/Task/Inventory/Generic/Dmidecode/Bios.pm b/lib/FusionInventory/Agent/Task/Inventory/Generic/Dmidecode/Bios.pm
index eb21386..86a1068 100644
--- a/lib/FusionInventory/Agent/Task/Inventory/Generic/Dmidecode/Bios.pm
+++ b/lib/FusionInventory/Agent/Task/Inventory/Generic/Dmidecode/Bios.pm
@@ -70,14 +70,20 @@ sub _getBiosHardware {
             $bios->{BMANUFACTURER} =~ /(VirtualBox|innotek)/ ? 'VirtualBox' :
             $bios->{BMANUFACTURER} =~ /^Xen/                 ? 'Xen'        :
                                                                undef        ;
-    } elsif ($bios->{SMODEL}) {
-        $vmsystem =
-            $bios->{SMODEL} =~ /VMware/          ? 'VMWare'          :
-            $bios->{SMODEL} =~ /Virtual Machine/ ? 'Virtual Machine' :
-                                                    undef            ;
-    } elsif ($bios->{BVERSION}) {
-        $vmsystem =
-            $bios->{BVERSION} =~ /VirtualBox/ ? 'VirtualBox' : undef;
+    }
+    # We may have a BMANUFACTURER defined, but invalid, so we'll need to check
+    # SMODEL is $vmsystem is not defined
+    if (! defined $vmsystem) {
+        if ($bios->{SMODEL}) {
+            $vmsystem =
+                $bios->{SMODEL} =~ /VMware/          ? 'VMWare'          :
+                $bios->{SMODEL} =~ /KVM/             ? 'QEMU'            :
+                $bios->{SMODEL} =~ /Virtual Machine/ ? 'Virtual Machine' :
+                                                        undef            ;
+        } elsif ($bios->{BVERSION}) {
+            $vmsystem =
+                $bios->{BVERSION} =~ /VirtualBox/ ? 'VirtualBox' : undef;
+       }
     }
     $hardware->{VMSYSTEM} = $vmsystem if $vmsystem;
 
-- 
1.9.1

