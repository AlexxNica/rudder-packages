From 31b0fe61a6b1638fb8b975b6b7561518d0fde2a0 Mon Sep 17 00:00:00 2001
From: Bas van der Vlies <bas.vandervlies@surfsara.nl>
Date: Thu, 17 Dec 2015 10:23:14 +0100
Subject: [PATCH] @if minimum_version now correctly ignores lines starting with
 '@'

Redmine #7862.

Changelog: Title
---
 libpromises/cf3lex.l                               | 16 ++++++++----
 .../00_basics/macros/if_ignore_with_addsign.cf     | 30 ++++++++++++++++++++++
 2 files changed, 41 insertions(+), 5 deletions(-)
 create mode 100644 tests/acceptance/00_basics/macros/if_ignore_with_addsign.cf

diff --git a/libpromises/cf3lex.l b/libpromises/cf3lex.l
index db79a1f..45a4d0d 100644
--- a/libpromises/cf3lex.l
+++ b/libpromises/cf3lex.l
@@ -87,6 +87,7 @@ comment    #[^\n]*
 macro_if_version    ^@if\ minimum_version\([0-9]{1,10}\.[0-9]{1,10}(\.[0-9]{1,10})?\)
 macro_if_feature    ^@if\ feature\([a-zA-Z0-9_]+\)
 macro_endif ^@endif
+macro_line ^[^@].*$
 
 promises   bundle
 
@@ -243,6 +244,11 @@ promise_type   [a-zA-Z_]+:
                         P.if_depth--;
                       }
 
+
+<if_ignore_state>{macro_line}  {
+                                  ParserDebug("\tL:inside macro @if, ignoring text:%s\n", yytext);
+                               }
+
 <if_ignore_state>{macro_endif} {
                                  ParserDebug("\tL:macro @endif %d\n", P.line_pos);
                                  BEGIN(INITIAL);
@@ -252,11 +258,11 @@ promise_type   [a-zA-Z_]+:
                                    return 0;
                                  }
                                  P.if_depth--;
-                               }
-
-<if_ignore_state>[^@]      {
-                               ParserDebug("\tL:inside macro @if, ignoring text:%s\n", yytext);
-                           }
+                               }\
+<if_ignore_state>.    {
+                          /* eat up al unknown chars when line starts with @*/
+                          ParserDebug("\tL:inside macro @if, ignoring text:%s\n", yytext);
+                      }
 
 {promises}            {
                           /* Note this has to come before "id" since it is a subset of id */
diff --git a/tests/acceptance/00_basics/macros/if_ignore_with_addsign.cf b/tests/acceptance/00_basics/macros/if_ignore_with_addsign.cf
new file mode 100644
index 0000000..63dd940
--- /dev/null
+++ b/tests/acceptance/00_basics/macros/if_ignore_with_addsign.cf
@@ -0,0 +1,30 @@
+######################################################
+#
+#  Test that @if works for greater versions
+#
+#####################################################
+
+body common control
+{
+      inputs => { "../../default.cf.sub" };
+      bundlesequence  => { default("$(this.promise_filename)") };
+      version => "1.0";
+}
+
+bundle common test
+{
+@if minimum_version(300.600)
+      Some new function here...
+@should_pass 
+      bundle agent netgroup(@netgroup_list)
+      more text...
+@endif
+}
+
+bundle agent check
+{
+  methods:
+      "" usebundle => dcs_passif_expected("cfengine",
+                                         "",
+                                         $(this.promise_filename));
+}
