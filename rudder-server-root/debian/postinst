#!/bin/sh
# postinst script for rudder-server-root
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
		echo 'root' > /opt/rudder/etc/uuid.hive
		# Is this the first installation?
		LDAPCHK=`/opt/rudder/sbin/slapcat  | grep "^dn: " | wc -l`
		if [ $LDAPCHK -eq 0 ]; then
			echo "************************************************************"
			echo "Rudder is now installed but not configured."
			echo "Please run /opt/rudder/bin/rudder-init.sh"
			echo "************************************************************"
		else
			# If it is an upgrade try to send inventory
			## Check that the inventory has not been sent for 24 hours
			SERVER_INVENTORY_DATE=`/opt/rudder/sbin/slapcat | perl -p0e 's/\n //g' | perl -p0e 's/\n([^\n])/%%%%\1/g' |\
				 grep -i "^%%%%dn: nodeId=root,ou=Nodes,ou=Accepted Inventories,ou=Inventories,cn=rudder-configuration" |\
				 grep -iE --color "%%%%(inventoryDate)::? " | sed 's/.*inventoryDate: \([0-9]*+[0-9]*\).*/\1/g'`
			DATE_CHECK=`perl -e 'use Time::Piece; my $date = shift; my $time = Time::Piece->strptime($date, "%Y%m%d%H%M%S%z"); $time += $time->localtime->tzoffset; print $time->strftime("%s");' ${SERVER_INVENTORY_DATE}`
			DATE_REF=`date -d '24 hours ago' +%s`
			if [ ${DATE_CHECK} -lt ${DATE_REF} ]; then
				echo "The last inventory of the root server is older than 24 hours"
				## If the inventory of the root server is older than 24 hours
				## create invtenroy of the machine
				echo "A new inventory will be created..."
				/opt/rudder/bin/run-inventory --local=/var/rudder/tmp/inventory --scan-homedirs 2&>1
				## And move the inventory in the foler which will process it
				## when the application will be available
				mv /var/rudder/tmp/inventory/*.ocs /var/rudder/inventories/incoming/
				echo "Done."
			fi
		fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
