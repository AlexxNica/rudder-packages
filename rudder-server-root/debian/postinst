#!/bin/sh
# postinst script for rudder-server-root
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
		echo 'root' > /opt/rudder/etc/uuid.hive
		# Is this the first installation?
		LDAPCHK=`/opt/rudder/sbin/slapcat  | grep "^dn: " | wc -l`
		if [ $LDAPCHK -eq 0 ]; then
			echo "************************************************************"
			echo "Rudder is now installed but not configured."
			echo "Please run /opt/rudder/bin/rudder-init.sh"
			echo "************************************************************"
		else
			# If it is an upgrade try to send inventory
			## Check that the inventory has not been sent for 24 hours
			SERVER_INVENTORY_DATE=`/opt/rudder/sbin/slapcat | perl -p0e 's/\n //g' | perl -p0e 's/\n([^\n])/%%%%\1/g' |\
				 grep -i "^%%%%dn: nodeId=root,ou=Nodes,ou=Accepted Inventories,ou=Inventories,cn=rudder-configuration" |\
				 grep -iE --color "%%%%(inventoryDate)::? " | sed 's/.*inventoryDate: \([0-9]*\).*/\1/g'`
			DATE_CHECK=`perl -e 'use Time::Piece; my $date = shift; my $time = Time::Piece->strptime($date, "%Y%m%d%H%M%S"); $time += $time->localtime->tzoffset; print $time->strftime("%s");' ${SERVER_INVENTORY_DATE}`
			DATE_REF=`date -d '24 hours ago' +%s`
			if [ ${DATE_CHECK} -lt ${DATE_REF} ]; then
				echo "The last inventory of the root server is older than 24 hours"
				## If the inventory of the root server is older than 24 hours
				## create invtenroy of the machine
				echo "A new inventory will be created..."
				UUID=`/bin/cat /opt/rudder/etc/uuid.hive`
				RUDDERUUID=`/usr/sbin/dmidecode -s system-uuid`
				USER=`/usr/bin/whoami`
				CFKEY=`/bin/cat /var/rudder/cfengine-community/ppkeys/localhost.pub`
				HOST_INV=`grep "^base.url\s*=" /opt/rudder/etc/rudder-web.properties | sed 's%^base.url\s*=\s*https\?://\(.*\)/.*$%\1%'`
				## We assume that root server is sending inventory to itself
				POLSRVUUID=${UUID}
				## Make sure that the folder to make inventory exists
				mkdir -p /var/rudder/tmp/inventory/
				/opt/rudder/bin/run-inventory --local=/var/rudder/tmp/inventory --scan-homedirs
				echo "...adding extra informations..."
				FILE_TMP=`mktemp`
				FILE_SRC=`find /var/rudder/tmp/inventory/ -name "*.ocs"`
				echo "Transitional files: ${FILE_TMP} and ${FILE_SRC}"
				## Cut file in two in order to add extra mandatory information 2 lines before the end
				head -n-2 ${FILE_SRC} > ${FILE_TMP}
				echo -e "\n<UUID>${UUID}</UUID>\n<USER>${USER}</USER>\n<AGENTSNAME><AGENTNAME>Community</AGENTNAME>\n</AGENTSNAME>\n<MACHINEID>${RUDDERUUID}</MACHINEID>\n<CFKEY>${CFKEY}</CFKEY>\n<HOSTNAME>${HOST_INV}</HOSTNAME>\n<POLICY_SERVER>${POLSRVUUID}</POLICY_SERVER>\n<QUERY>INVENTORY</QUERY>\n</REQUEST>" >> ${FILE_TMP}
				cp -f ${FILE_TMP} ${FILE_SRC}
				## And move the inventory in the foler which will process it
				## when the application will be available
				mv /var/rudder/tmp/inventory/*.ocs /var/rudder/inventories/incoming/
				## Remove temporary folder and files generated
				rm -rf /var/rudder/tmp/inventory/
				echo "Done."
			fi
		fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
